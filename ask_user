#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç°ä»£åŒ–å‘½ä»¤è¡Œæ–‡å­—è¾“å…¥å·¥å…· - è‡ªå®šä¹‰æ ‡é¢˜æ ç‰ˆæœ¬
ç”¨æ³•: python ask_user_custom_titlebar.py "æ‚¨çš„æç¤ºä¿¡æ¯"
"""

import sys
import os
import argparse
import tkinter as tk
from tkinter import messagebox


class ModernPromptInputWindow:
    def __init__(self, prompt_text):
        self.result = None
        self.root = tk.Tk()
        
        # è·å–å½“å‰ç›®å½•åç§°ä½œä¸ºæ ‡é¢˜
        current_dir = os.path.basename(os.getcwd())
        self.root.title(f"ğŸ’» {current_dir} ")

        
        self.root.geometry("600x450")  # å¢åŠ é«˜åº¦ä»¥é€‚åº”è‡ªå®šä¹‰æ ‡é¢˜æ 
        
        # å…¨å±€ç½®é¡¶
        self.root.attributes("-topmost", True)
        
        # éšè—ç³»ç»Ÿæ ‡é¢˜æ ä½†ä¿æŒä»»åŠ¡æ å›¾æ ‡ï¼ˆWindowsç‰¹å®šï¼‰
        try:
            # åœ¨Windowsä¸Šéšè—æ ‡é¢˜æ ä½†ä¿æŒä»»åŠ¡æ å›¾æ ‡
            self.root.attributes('-toolwindow', False)
            self.root.overrideredirect(True)
        except:
            # å¦‚æœä¸Šé¢çš„æ–¹æ³•ä¸å·¥ä½œï¼Œåˆ™å°è¯•å…¶ä»–æ–¹æ³•
            self.root.overrideredirect(True)
        
        # ä½¿ç”¨ç°ä»£ç¼–ç¨‹å·¥å…·çš„æ·±è‰²ä¸»é¢˜
        self.root.configure(bg='#2d2d30')
        
        # è®¾ç½®çª—å£å›¾æ ‡ï¼ˆå¯é€‰ï¼Œå¦‚æœæœ‰å›¾æ ‡æ–‡ä»¶çš„è¯ï¼‰
        try:
            # è¿™é‡Œå¯ä»¥è®¾ç½®çª—å£å›¾æ ‡ï¼Œå¦‚æœæœ‰å›¾æ ‡æ–‡ä»¶çš„è¯
            # self.root.iconbitmap("icon.ico")
            pass
        except:
            pass
        
        # ç”¨äºæ‹–æ‹½çª—å£
        self.drag_data = {"x": 0, "y": 0}
        
        # è·å–å½“å‰ç›®å½•åç§°ç”¨äºç•Œé¢æ˜¾ç¤º
        self.current_dir_name = current_dir
        
        # åˆ›å»ºç°ä»£åŒ–ç•Œé¢
        self.create_widgets(prompt_text)
        self.setup_bindings()
        
        # åœ¨ç•Œé¢åˆ›å»ºå®Œæˆåå±…ä¸­æ˜¾ç¤º
        self.center_window()
    
    def center_window(self):
        self.root.update_idletasks()
        width, height = 600, 450
        x = (self.root.winfo_screenwidth() // 2) - (width // 2)
        y = (self.root.winfo_screenheight() // 2) - (height // 2)
        self.root.geometry(f"{width}x{height}+{x}+{y}")
    
    def create_custom_titlebar(self, parent):
        """åˆ›å»ºè‡ªå®šä¹‰æ ‡é¢˜æ """
        titlebar_frame = tk.Frame(parent, bg='#2d2d30', height=30)
        titlebar_frame.pack(fill='x', pady=0)
        titlebar_frame.pack_propagate(False)
        
        # æ ‡é¢˜æ–‡å­— - æ˜¾ç¤ºå½“å‰ç›®å½•åç§°
        title_label = tk.Label(titlebar_frame, text=f"ğŸ’» {self.current_dir_name} - æ–‡å­—è¾“å…¥", 
                              font=('Consolas', 10, 'bold'), 
                              bg='#2d2d30', fg='#569cd6',
                              anchor='w')
        title_label.pack(side='left', padx=10, pady=5)
        
        # å…³é—­æŒ‰é’®
        close_btn = tk.Button(titlebar_frame, text="âœ•", 
                             font=('Consolas', 12, 'bold'),
                             bg='#2d2d30', fg='#cccccc',
                             relief='flat', bd=0, width=3,
                             activebackground='#e74c3c',
                             activeforeground='#ffffff',
                             command=self.on_cancel,
                             cursor='hand2')
        close_btn.pack(side='right', padx=(0, 5), pady=2)
        
        # æœ€å°åŒ–æŒ‰é’®
        minimize_btn = tk.Button(titlebar_frame, text="â”€", 
                                font=('Consolas', 12, 'bold'),
                                bg='#2d2d30', fg='#cccccc',
                                relief='flat', bd=0, width=3,
                                activebackground='#3e3e42',
                                activeforeground='#ffffff',
                                command=self.minimize_window,
                                cursor='hand2')
        minimize_btn.pack(side='right', padx=2, pady=2)
        
        # ç½®é¡¶åˆ‡æ¢æŒ‰é’®
        self.topmost_btn = tk.Button(titlebar_frame, text="ğŸ“Œ", 
                                    font=('Consolas', 10, 'bold'),
                                    bg='#2d2d30', fg='#569cd6',
                                    relief='flat', bd=0, width=3,
                                    activebackground='#3e3e42',
                                    activeforeground='#ffffff',
                                    command=self.toggle_topmost,
                                    cursor='hand2')
        self.topmost_btn.pack(side='right', padx=2, pady=2)
        
        # ç»‘å®šæ‹–æ‹½äº‹ä»¶åˆ°æ ‡é¢˜æ 
        titlebar_frame.bind("<Button-1>", self.start_drag)
        titlebar_frame.bind("<B1-Motion>", self.do_drag)
        title_label.bind("<Button-1>", self.start_drag)
        title_label.bind("<B1-Motion>", self.do_drag)
        
        return titlebar_frame
    
    def toggle_topmost(self):
        """åˆ‡æ¢ç½®é¡¶çŠ¶æ€"""
        current_topmost = self.root.attributes("-topmost")
        new_topmost = not current_topmost
        self.root.attributes("-topmost", new_topmost)
        
        # æ›´æ–°æŒ‰é’®é¢œè‰²
        if new_topmost:
            self.topmost_btn.configure(fg='#569cd6')  # è“è‰²è¡¨ç¤ºå·²ç½®é¡¶
        else:
            self.topmost_btn.configure(fg='#cccccc')  # ç°è‰²è¡¨ç¤ºæœªç½®é¡¶
    
    def start_drag(self, event):
        """å¼€å§‹æ‹–æ‹½"""
        self.drag_data["x"] = event.x
        self.drag_data["y"] = event.y
    
    def do_drag(self, event):
        """æ‰§è¡Œæ‹–æ‹½"""
        x = self.root.winfo_x() + event.x - self.drag_data["x"]
        y = self.root.winfo_y() + event.y - self.drag_data["y"]
        self.root.geometry(f"+{x}+{y}")
    
    def minimize_window(self):
        """æœ€å°åŒ–çª—å£"""
        self.root.iconify()
    
    def create_widgets(self, prompt_text):
        # åˆ›å»ºä¸»å®¹å™¨
        main_container = tk.Frame(self.root, bg='#2d2d30')
        main_container.pack(fill='both', expand=True)
        
        # åˆ›å»ºè‡ªå®šä¹‰æ ‡é¢˜æ 
        self.create_custom_titlebar(main_container)
        
        # åˆ†éš”çº¿
        separator = tk.Frame(main_container, bg='#3e3e42', height=1)
        separator.pack(fill='x')
        
        # åˆ›å»ºå†…å®¹åŒºåŸŸ
        content_frame = tk.Frame(main_container, bg='#2d2d30', padx=20, pady=20)
        content_frame.pack(fill='both', expand=True)
        
        # æç¤ºæ ‡ç­¾ - ä½¿ç”¨ç¼–ç¨‹å·¥å…·å¸¸è§çš„è“è‰²ï¼Œæ”¯æŒè‡ªåŠ¨æ¢è¡Œ
        prompt_label = tk.Label(content_frame, text=f"ğŸ’» {prompt_text}", 
                               font=('Consolas', 13, 'normal'), 
                               bg='#2d2d30', fg='#569cd6',
                               anchor='w', justify='left',
                               wraplength=560)  # è®¾ç½®è‡ªåŠ¨æ¢è¡Œå®½åº¦
        prompt_label.pack(anchor='w', pady=(0, 15), fill='x')
        
        # æ–‡æœ¬è¾“å…¥åŒºåŸŸå®¹å™¨
        text_container = tk.Frame(content_frame, bg='#1e1e1e', relief='solid', bd=1)
        text_container.pack(fill='both', expand=True, pady=(0, 15))
        
        # æ–‡æœ¬è¾“å…¥ - ä½¿ç”¨VS Codeé£æ ¼é…è‰²
        self.text_area = tk.Text(text_container, 
                                height=10, 
                                font=('Consolas', 12),
                                relief='flat', 
                                bd=0, 
                                wrap='none', 
                                undo=True, 
                                maxundo=20,
                                bg='#1e1e1e',         # VS Codeæ·±è‰²èƒŒæ™¯
                                fg='#d4d4d4',         # æµ…ç°è‰²æ–‡å­—
                                insertbackground='#ffffff',  # ç™½è‰²å…‰æ ‡
                                selectbackground='#264f78',  # è“è‰²é€‰æ‹©èƒŒæ™¯
                                selectforeground='#ffffff')  # ç™½è‰²é€‰æ‹©æ–‡å­—
        
        # æ·»åŠ æ»šåŠ¨æ¡ - æ·±è‰²ä¸»é¢˜ï¼Œé»˜è®¤éšè—
        self.scrollbar_v = tk.Scrollbar(text_container, orient='vertical', 
                                       command=self.text_area.yview,
                                       bg='#3e3e42', troughcolor='#2d2d30',
                                       activebackground='#007acc')
        self.scrollbar_h = tk.Scrollbar(text_container, orient='horizontal', 
                                       command=self.text_area.xview,
                                       bg='#3e3e42', troughcolor='#2d2d30',
                                       activebackground='#007acc')
        
        # é…ç½®æ»šåŠ¨æ¡
        self.text_area.config(yscrollcommand=self.on_text_scroll_v, 
                             xscrollcommand=self.on_text_scroll_h)
        
        # å¸ƒå±€
        self.text_area.pack(side='left', fill='both', expand=True)
        
        # åº•éƒ¨ä¿¡æ¯å’ŒæŒ‰é’®åŒºåŸŸ
        info_frame = tk.Frame(content_frame, bg='#2d2d30')
        info_frame.pack(fill='x', pady=(5, 0))
        
        # æç¤ºä¿¡æ¯ - ç®€åŒ–å¿«æ·é”®æç¤º
        hint_label = tk.Label(info_frame, 
                             text="ğŸ’¡ Ctrl+Enter æäº¤  â€¢  Esc å–æ¶ˆ  â€¢  Ctrl+A å…¨é€‰",
                             font=('Consolas', 9), 
                             bg='#2d2d30', fg='#808080')
        hint_label.pack(side='left')
        
        # æŒ‰é’®åŒºåŸŸ
        button_frame = tk.Frame(info_frame, bg='#2d2d30')
        button_frame.pack(side='right')
        
        # å–æ¶ˆæŒ‰é’® - ç°è‰²ä¸»é¢˜
        cancel_btn = tk.Button(button_frame, text="å–æ¶ˆ", command=self.on_cancel,
                              font=('Consolas', 10), width=8,
                              bg='#3e3e42', fg='#cccccc',
                              relief='flat', bd=1,
                              activebackground='#4e4e52',
                              activeforeground='#ffffff',
                              cursor='hand2')
        cancel_btn.pack(side='right', padx=(10, 0))
        
        # å®ŒæˆæŒ‰é’® - è“è‰²ä¸»é¢˜
        submit_btn = tk.Button(button_frame, text="å®Œæˆ", command=self.on_submit,
                              font=('Consolas', 10, 'bold'), width=8,
                              bg='#007acc', fg='white',
                              relief='flat', bd=1,
                              activebackground='#005a9e',
                              activeforeground='#ffffff',
                              cursor='hand2')
        submit_btn.pack(side='right')
        
        # å ä½ç¬¦è®¾ç½®
        self.placeholder_text = "åœ¨æ­¤è¾“å…¥æ‚¨çš„å†…å®¹..."
        self.is_placeholder = True
        self.show_placeholder()
    
    def on_text_scroll_v(self, *args):
        """å‚ç›´æ»šåŠ¨æ¡å›è°ƒï¼Œè‡ªåŠ¨æ˜¾ç¤º/éšè—"""
        self.scrollbar_v.set(*args)
        self.auto_show_hide_scrollbars()
    
    def on_text_scroll_h(self, *args):
        """æ°´å¹³æ»šåŠ¨æ¡å›è°ƒï¼Œè‡ªåŠ¨æ˜¾ç¤º/éšè—"""
        self.scrollbar_h.set(*args)
        self.auto_show_hide_scrollbars()
    
    def auto_show_hide_scrollbars(self):
        """è‡ªåŠ¨æ˜¾ç¤º/éšè—æ»šåŠ¨æ¡"""
        # æ£€æŸ¥æ˜¯å¦éœ€è¦å‚ç›´æ»šåŠ¨æ¡
        v_pos = self.scrollbar_v.get()
        if v_pos[0] <= 0.0 and v_pos[1] >= 1.0:
            # ä¸éœ€è¦å‚ç›´æ»šåŠ¨æ¡
            self.scrollbar_v.pack_forget()
        else:
            # éœ€è¦å‚ç›´æ»šåŠ¨æ¡
            self.scrollbar_v.pack(side='right', fill='y')
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ°´å¹³æ»šåŠ¨æ¡
        h_pos = self.scrollbar_h.get()
        if h_pos[0] <= 0.0 and h_pos[1] >= 1.0:
            # ä¸éœ€è¦æ°´å¹³æ»šåŠ¨æ¡
            self.scrollbar_h.pack_forget()
        else:
            # éœ€è¦æ°´å¹³æ»šåŠ¨æ¡
            self.scrollbar_h.pack(side='bottom', fill='x')
    
    def setup_bindings(self):
        # ç»‘å®šäº‹ä»¶
        self.text_area.focus_set()
        self.root.bind('<Control-Return>', lambda e: self.on_submit())
        self.root.bind('<Escape>', lambda e: self.on_cancel())
        self.root.protocol("WM_DELETE_WINDOW", self.on_cancel)
        
        # æ·»åŠ æ’¤é”€é‡åšå¿«æ·é”®
        self.root.bind('<Control-z>', lambda e: self.undo_text())
        self.root.bind('<Control-y>', lambda e: self.redo_text())
        self.root.bind('<Control-Shift-Z>', lambda e: self.redo_text())  # æ”¯æŒShift+Ctrl+Zé‡åš
        
        # è‡ªå®šä¹‰å…¨é€‰åŠŸèƒ½
        self.text_area.bind('<Control-a>', self.select_all_text)
        
        # æ–‡æœ¬æ¡†äº‹ä»¶ç»‘å®š
        self.text_area.bind('<FocusIn>', self.on_text_focus_in)
        self.text_area.bind('<FocusOut>', self.on_text_focus_out)
        self.text_area.bind('<KeyPress>', self.on_key_press)
        
        # ç»‘å®šæ–‡æœ¬å˜åŒ–äº‹ä»¶ï¼Œç”¨äºæ»šåŠ¨æ¡è‡ªåŠ¨æ˜¾ç¤º/éšè—
        self.text_area.bind('<Configure>', lambda e: self.root.after_idle(self.auto_show_hide_scrollbars))
        self.text_area.bind('<KeyRelease>', lambda e: self.root.after_idle(self.auto_show_hide_scrollbars))
        
        # é»˜è®¤é€‰ä¸­æ‰€æœ‰æ–‡æœ¬
        self.root.after(100, self.select_initial_text)
    
    def show_placeholder(self):
        """æ˜¾ç¤ºå ä½ç¬¦æ–‡æœ¬"""
        self.text_area.delete('1.0', 'end')
        self.text_area.insert('1.0', self.placeholder_text)
        self.text_area.config(fg='#6a6a6a')  # æ·±è‰²ä¸»é¢˜ä¸‹çš„å ä½ç¬¦é¢œè‰²
        self.is_placeholder = True
    
    def clear_placeholder(self):
        """æ¸…é™¤å ä½ç¬¦æ–‡æœ¬"""
        if self.is_placeholder:
            self.text_area.delete('1.0', 'end')
            self.text_area.config(fg='#d4d4d4')  # æ¢å¤æ­£å¸¸æ–‡å­—é¢œè‰²
            self.is_placeholder = False
    
    def on_text_focus_in(self, event):
        """æ–‡æœ¬æ¡†è·å¾—ç„¦ç‚¹æ—¶"""
        if self.is_placeholder:
            self.clear_placeholder()
    
    def on_text_focus_out(self, event):
        """æ–‡æœ¬æ¡†å¤±å»ç„¦ç‚¹æ—¶"""
        content = self.text_area.get('1.0', 'end-1c').strip()
        if not content:
            self.show_placeholder()
    
    def on_key_press(self, event):
        """å¤„ç†æŒ‰é”®äº‹ä»¶"""
        if self.is_placeholder and event.keysym not in ['Control_L', 'Control_R', 'Alt_L', 'Alt_R', 'Shift_L', 'Shift_R']:
            self.clear_placeholder()
    
    def select_all_text(self, event):
        """è‡ªå®šä¹‰å…¨é€‰åŠŸèƒ½ï¼Œåªé€‰ä¸­å®é™…æ–‡æœ¬å†…å®¹"""
        if self.is_placeholder:
            return "break"
        
        content = self.text_area.get('1.0', 'end-1c')
        if content:
            lines = content.split('\n')
            last_line = len(lines)
            last_char = len(lines[-1])
            end_pos = f"{last_line}.{last_char}"
            
            self.text_area.tag_remove('sel', '1.0', 'end')
            self.text_area.tag_add('sel', '1.0', end_pos)
            self.text_area.mark_set('insert', end_pos)
        
        return "break"
    
    def select_initial_text(self):
        """åˆå§‹é€‰ä¸­æ–‡æœ¬ï¼Œæ–¹ä¾¿ç”¨æˆ·ç›´æ¥è¾“å…¥"""
        if self.is_placeholder:
            self.text_area.tag_add('sel', '1.0', f'1.{len(self.placeholder_text)}')
            self.text_area.mark_set('insert', '1.0')
    
    def undo_text(self):
        """æ’¤é”€æ“ä½œ"""
        try:
            self.text_area.event_generate('<<Undo>>')
        except:
            pass
    
    def redo_text(self):
        """é‡åšæ“ä½œ"""
        try:
            self.text_area.event_generate('<<Redo>>')
        except:
            pass
    
    def on_submit(self):
        if self.is_placeholder:
            messagebox.showwarning("æç¤º", "è¯·è¾“å…¥å†…å®¹åå†æäº¤ï¼")
            self.text_area.focus_set()
            return
        
        content = self.text_area.get("1.0", "end-1c").strip()
        if not content:
            messagebox.showwarning("æç¤º", "è¯·è¾“å…¥å†…å®¹åå†æäº¤ï¼")
            self.text_area.focus_set()
            return
        self.result = content
        self.root.quit()
        self.root.destroy()
    
    def on_cancel(self):
        self.result = None
        self.root.quit()
        self.root.destroy()
    
    def show(self):
        self.root.mainloop()
        return self.result


def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(description="ç°ä»£åŒ–å‘½ä»¤è¡Œæ–‡å­—è¾“å…¥å·¥å…· - è‡ªå®šä¹‰æ ‡é¢˜æ ç‰ˆæœ¬")
    parser.add_argument("prompt", nargs='?', default="è¯·è¾“å…¥æ‚¨çš„å†…å®¹ï¼š", 
                       help="æ˜¾ç¤ºåœ¨çª—å£ä¸­çš„æç¤ºä¿¡æ¯")
    parser.add_argument("--version", action="version", version="3.1.0")
    
    args = parser.parse_args()
    
    try:
        # åˆ›å»ºå¹¶æ˜¾ç¤ºè¾“å…¥çª—å£
        window = ModernPromptInputWindow(args.prompt)
        result = window.show()
        
        # è¾“å‡ºç»“æœ
        if result is not None:
            print(result)
        else:
            print("ç”¨æˆ·å–æ¶ˆäº†è¾“å…¥", file=sys.stderr)
            sys.exit(1)
            
    except KeyboardInterrupt:
        print("\nç¨‹åºè¢«ç”¨æˆ·ä¸­æ–­", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"ç¨‹åºè¿è¡Œå‡ºé”™: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main() 
